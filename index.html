<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Website-Generator KI</title>
  <style>
    :root { --bg:#0b1022; --panel:#0f172a; --muted:#94a3b8; --border:rgba(148,163,184,.3); --accent:#3b82f6; --accent2:#1d4ed8; --text:#e5e7eb; }
    *{box-sizing:border-box}
    body{font-family:Arial, sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;min-height:100vh;margin:0;padding:30px}
    h1{margin:0 0 8px}
    p.hint{color:var(--muted);margin:0 0 8px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    input,button,textarea{border-radius:10px;font-size:14px;border:1px solid var(--border);background:var(--panel);color:var(--text)}
    textarea{width:90%;max-width:900px;height:140px;padding:12px;margin:8px 0}
    button{padding:10px;cursor:pointer}
    .btn{background:linear-gradient(180deg,var(--accent),var(--accent2));border:1px solid rgba(0,0,0,.25)}
    .btn:hover{filter:brightness(1.08)}
    .btn-ghost{background:#0b1220;border:1px solid rgba(148,163,184,.4)}
    #preview{margin-top:16px;width:90%;max-width:1100px;background:var(--panel);border-radius:12px;padding:16px;border:1px solid rgba(148,163,184,.25);min-height:240px}
    .status{font-size:13px;color:var(--muted);margin-top:8px;min-height:18px}
    .err{color:#fca5a5}
    .assets{width:90%;max-width:900px;color:var(--muted);font-size:13px}
    .assets ul{margin:6px 0 0 16px;padding:0}
    .assets li{margin:4px 0}
    .thumb{display:inline-flex;align-items:center;gap:8px;margin:2px 0}
    .thumb img{width:44px;height:44px;object-fit:cover;border-radius:6px;border:1px solid var(--border)}
  </style>
  <link rel="icon" href="/static/logo.jpg">
</head>
<body>
  <img src="/static/logo.jpg" alt="Logo" style="width:120px;border-radius:12px;margin-bottom:10px" onerror="this.style.display='none'">
  <h1>üß† Website-Generator KI</h1>

  <p class="hint">Beschreibe deine Website:</p>
  <textarea id="prompt" placeholder="z. B. One-Pager mit Hero, Leistungen, Galerie (nutze hochgeladene Bilder), Kontakt."></textarea>

  <div class="row" id="modelRow">
    <!-- Modellkarten werden per JS gerendert -->
  </div>

  <div class="row">
    <button id="btnGen" class="btn">Website erstellen</button>
    <button id="btnSave" class="btn-ghost">Als HTML speichern</button>
    <button id="btnBundle" class="btn-ghost" disabled>Bundle herunterladen</button>
  </div>

  <div class="row">
    <input id="fileInput" type="file" multiple accept="image/*" />
    <button id="btnUpload" class="btn">Bilder hochladen</button>
  </div>

  <div class="assets" id="assetsBox" style="display:none">
    <strong>Hochgeladene Bilder:</strong>
    <ul id="assetsList"></ul>
  </div>

  <div class="status" id="status"></div>
  <div id="preview">üí° Hier erscheint deine generierte Website ‚Ä¶</div>

  <script>
    const $ = s => document.querySelector(s);
    const statusEl = $("#status");
    const preview  = $("#preview");
    const assetsBox = $("#assetsBox");
    const assetsList = $("#assetsList");
    const btnBundle = $("#btnBundle");
    const modelsRow = $("#modelRow");

    let currentBundleId = null;
    let currentAssets = [];
    let selectedModel = "qwen3-coder:480b-cloud";
    let maxTokens = 1800;
    let temperature = 0.20;

    const PRESETS = {
      "deepseek-v3.1:671b-cloud": {label:"DeepSeek V3.1", ctx:65536,  ideal:3000, cap:8000, temp:0.30},
      "qwen3-coder:480b-cloud":   {label:"Qwen3 Coder",   ctx:131072, ideal:1800, cap:8192, temp:0.20},
      "glm-4.6:cloud":            {label:"GLM-4.6",       ctx:131072, ideal:1600, cap:8192, temp:0.35},
      "gpt-oss:120b-cloud":       {label:"GPT-OSS 120B",  ctx:65536,  ideal:1400, cap:8192, temp:0.35},
      "qwen3-vl:235b-cloud":      {label:"Qwen3-VL",      ctx:262144, ideal:1500, cap:6144, temp:0.40},
      "minimax-m2:cloud":         {label:"MiniMax-M2",    ctx:200000, ideal:1200, cap:8192, temp:0.40},
      "gpt-oss:20b-cloud":        {label:"GPT-OSS 20B",   ctx:32768,  ideal:900,  cap:4096, temp:0.45},
    };

    function setStatus(m, err=false){ statusEl.textContent=m||""; statusEl.className="status"+(err?" err":""); }

    function renderModelCards(){
      modelsRow.innerHTML = "";
      Object.entries(PRESETS).forEach(([key, p])=>{
        const card = document.createElement("button");
        card.type = "button";
        card.style.cssText = "border:1px solid var(--border);background:var(--panel);border-radius:12px;padding:10px;cursor:pointer;min-width:210px";
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:12px">
            <div><b>${p.label}</b><br><span style="font-size:12px;color:#9fb1cc">${(p.ctx/1024).toFixed(0)}k ctx</span></div>
            <div style="font-size:12px;color:#cbd5e1;text-align:right">ideal ${p.ideal}<br>cap ${p.cap}<br>temp ${p.temp}</div>
          </div>
        `;
        card.addEventListener("click", ()=>{
          selectedModel = key;
          maxTokens = p.ideal;
          temperature = p.temp;
          setStatus(`Modell: ${p.label} ‚Ä¢ ctx ${(p.ctx/1024).toFixed(0)}k ‚Ä¢ max_tokens ${maxTokens} (cap ${p.cap}) ‚Ä¢ temp ${temperature}`);
        });
        modelsRow.appendChild(card);
      });
    }
    renderModelCards();
    setStatus(`Modell: ${PRESETS[selectedModel].label} ‚Ä¢ ctx ${(PRESETS[selectedModel].ctx/1024).toFixed(0)}k ‚Ä¢ max_tokens ${maxTokens}`);

    async function uploadFiles(){
      const inp = $("#fileInput");
      if(!inp.files.length){ setStatus("Bitte Bilder ausw√§hlen.", true); return; }
      const fd = new FormData();
      for(const f of inp.files){ fd.append("files", f, f.name); }
      if(currentBundleId){ fd.append("bundle_id", currentBundleId); }
      setStatus("Lade Bilder hoch ‚Ä¶");
      try{
        const res = await fetch("/upload", { method:"POST", body: fd });
        const data = await res.json();
        if(!res.ok){ throw new Error(data?.detail || res.statusText); }
        currentBundleId = data.bundle_id;
        currentAssets = data.assets || [];
        renderAssets();
        btnBundle.disabled = !currentBundleId;
        setStatus(`Hochgeladen: ${currentAssets.length} Datei(en).`);
      }catch(e){
        setStatus("Upload-Fehler: "+e.message, true);
      }
    }

    function renderAssets(){
      assetsList.innerHTML = "";
      for(const n of currentAssets){
        const li = document.createElement("li");
        li.className = "thumb";
        const img = document.createElement("img");
        if(currentBundleId){
          img.src = `/bundles/${currentBundleId}/assets/${encodeURIComponent(n)}`;
        }
        img.alt = n;
        li.appendChild(img);
        const span = document.createElement("span");
        span.textContent = n;
        li.appendChild(span);
        assetsList.appendChild(li);
      }
      assetsBox.style.display = currentAssets.length ? "block" : "none";
    }

    async function generate(){
      const prompt = $("#prompt").value.trim();
      if(!prompt){ setStatus("Bitte eine Beschreibung eingeben.", true); return; }
      setStatus("Erzeuge HTML ‚Ä¶");
      preview.innerHTML = "‚è≥ Die KI erstellt deine Website ‚Ä¶";
      try{
        const res = await fetch("/generate", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({
            prompt,
            model: selectedModel,
            max_tokens: maxTokens,
            temperature,
            bundle_id: currentBundleId,
            image_names: currentAssets.length ? currentAssets : undefined
          })
        });
        const raw = await res.text();
        if(!res.ok){ throw new Error(`HTTP ${res.status} ‚Äì ${raw.slice(0,300)}`); }
        const data = JSON.parse(raw);
        currentBundleId = data.bundle_id;
        btnBundle.disabled = !currentBundleId;

        // Wichtig: Vorschau-HTML mit absoluten Bundle-Pfaden verwenden
        const html = data?.html_preview || data?.html || "";
        if(!html) throw new Error("Leere Antwort vom Backend.");
        preview.innerHTML = html;

        if (data.applied){
          const a = data.applied;
          maxTokens = a.chosen_max;
          temperature = a.temperature;
          setStatus(`Server angewandt ‚Üí ${a.model_canonical} ‚Ä¢ ctx ${(a.context_window/1024).toFixed(0)}k ‚Ä¢ max_tokens ${a.chosen_max} / cap ${a.cap} ‚Ä¢ temp ${a.temperature}`);
        } else {
          setStatus("Fertig. Du kannst jetzt das Bundle herunterladen.");
        }
      }catch(e){
        setStatus("Fehler: "+e.message, true);
        preview.innerHTML = "üö´ Fehler beim Generieren.";
        console.error(e);
      }
    }

    function saveAsHtml(){
      // Speichert nur die sichtbare Vorschau. F√ºr vollst√§ndiges Projekt: ZIP nutzen.
      const html = preview.innerHTML;
      if(!html){ setStatus("Nichts zum Speichern.", true); return; }
      const blob = new Blob([html], {type:"text/html;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "website_preview.html";
      document.body.appendChild(a);
      a.click(); a.remove();
      URL.revokeObjectURL(a.href);
      setStatus("HTML gespeichert.");
    }

    function downloadBundle(){
      if(!currentBundleId){ setStatus("Kein Bundle vorhanden.", true); return; }
      const a = document.createElement("a");
      a.href = `/bundle/${currentBundleId}.zip`;
      a.download = `${currentBundleId}.zip`;
      document.body.appendChild(a);
      a.click(); a.remove();
      setStatus("Bundle wird heruntergeladen.");
    }

    $("#btnUpload").addEventListener("click", uploadFiles);
    $("#btnGen").addEventListener("click", generate);
    $("#btnSave").addEventListener("click", saveAsHtml);
    $("#btnBundle").addEventListener("click", downloadBundle);
  </script>
</body>
</html>
